{% extends "layout.html" %}
{% block title %}Blog & Galerie – Vianu Biologists{% endblock %}

{% block content %}
<section class="blog-wrap">
  <!-- ADN + butoane (overlay) -->
  <aside class="blog-dna">
    <svg viewBox="0 0 60 500" class="dna-slim" aria-label="ADN decorativ lateral">
      <!-- helix -->
      <path d="M20,10 C5,80 55,120 40,180 C25,240 35,300 20,360 C10,420 15,470 20,490"
            fill="none" stroke="#2e7d32" stroke-width="4"/>
      <path d="M40,10 C55,80 5,120 20,180 C35,240 25,300 40,360 C50,420 45,470 40,490"
            fill="none" stroke="#1565c0" stroke-width="4"/>
      <!-- am scos casetele colorate -->
    </svg>

    <!-- overlay peste ADN: ALBASTRU / ROȘU / ROȘU / ALBASTRU -->
    <nav class="blog-dna-nav">
      <a href="{{ url_for('blog') }}#insta"    class="pill pill-blue">INSTA</a>
      <a href="{{ url_for('blog') }}#articles" class="pill pill-red">ARTICOLE</a>
      <a href="{{ url_for('blog') }}#galerie"  class="pill pill-red">GALERIE</a>
      <a href="{{ url_for('index') }}"         class="pill pill-blue">HOME</a>
    </nav>

    {% if can_view_lessons %}
    <nav class="blog-dna-nav-secondary">
      <a href="{{ url_for('blog') }}#lectii" class="pill pill-red">LECȚII</a>
    </nav>
    {% endif %}
  </aside>

  <!-- CONȚINUT PRINCIPAL -->
  <div class="blog-content">
    <h2 class="posts-title">POSTĂRI</h2>

    <!-- Căutare după titlu -->
    <div class="search-bar">
      <input type="text" id="searchInput" onkeyup="searchPosts()" placeholder="Caută după titlu...">
    </div>

    <!-- Lista postărilor -->
    {% for p in posts %}
      <article class="post-item"
               id="{{ p.section }}{{ p.id }}"
               data-section="{{ p.section }}"
               data-title="{{ (p.title or '')|lower }}">

        <header class="post-head">
          <h3 class="post-title">
            {% if p.section == 'insta' %}
              Insta:
            {% elif p.section == 'gallery' %}
              Galerie:
            {% elif p.section == 'lectii' %}
              Lectie:
            {% else %}
              Articol:
            {% endif %}
            {{ p.title }}
          </h3>
          <small class="meta">
            <strong>Autor:</strong> {{ p.author or 'Club BIO' }}
            {% if p.created_at %} | <strong>Data:</strong> {{ p.created_at.strftime('%Y-%m-%d') }}{% endif %}
            | <strong>Secțiune:</strong>
            {% if p.section == 'insta' %}Insta{% elif p.section == 'gallery' %}Galerie{% elif p.section == 'lectii' %}Lecții{% else %}Articol{% endif %}
          </small>
        </header>

        {% if p.image_url %}
          <img src="{{ p.image_url }}" class="gallery-img" alt="cover">
        {% endif %}

        {% if p.content %}
          <p class="post-body">{{ p.content }}</p>
        {% endif %}

        <div class="post-actions">
          {# EXTERNAL_URL: dacă e PDF -> “Descarcă PDF” + “Vezi în browser”; altfel Link extern #}
          {% if p.external_url %}
            {% set link = p.external_url %}
            {% if link and (link|lower).endswith('.pdf') %}
              <a class="btn btn-download" href="{{ link }}" download>Descarcă PDF</a>
              <a class="btn ghost" href="{{ link }}" target="_blank" rel="noopener">Vezi în browser</a>
            {% else %}
              <a class="btn ghost" href="{{ link }}" target="_blank" rel="noopener">Link extern</a>
            {% endif %}
          {% endif %}

          {# LECȚII: dacă ppt_url e PDF -> download; altfel „Deschide prezentarea” #}
          {% if p.section == 'lectii' and p.ppt_url %}
            {% set link2 = p.ppt_url %}
            {% if link2 and (link2|lower).endswith('.pdf') %}
              <a class="btn btn-download" href="{{ link2 }}" download>Descarcă PDF</a>
              <a class="btn ghost" href="{{ link2 }}" target="_blank" rel="noopener">Vezi în browser</a>
            {% else %}
              <a class="btn" href="{{ link2 }}" target="_blank" rel="noopener">Deschide prezentarea</a>
            {% endif %}
          {% endif %}
        </div>
      </article>
    {% else %}
      <p>Nu există postări încă. Adaugă din <a href="{{ url_for('admin_new') }}">admin</a>.</p>
    {% endfor %}
  </div>
</section>

<style>
/* Layout general */
.blog-wrap{
  display:grid;
  grid-template-columns: 240px 1fr;
  gap:24px;
  margin-top:18px;
}

/* ADN + overlay */
.blog-dna{
  position: sticky;
  top: 16px;
  align-self: start;
  display: block;
  min-height: 520px;
}
.dna-slim{
  width: 120px;            /* ADN mai mic */
  height: auto;
  display: block;
  margin: 0 auto;
  position: relative;
  z-index: 1;              /* sub butoane */
  filter: drop-shadow(0 4px 12px rgba(0,0,0,.1));
}

/* Overlay cu butoane, peste ADN */
.blog-dna-nav{
  position: absolute;
  top: 14%;
  left: 50%;
  transform: translateX(-50%);
  width: 230px;
  display: flex;
  flex-direction: column;
  gap: 22px;               /* distanță mai mare între butoane */
  z-index: 2;
}
.blog-dna-nav-secondary{
  margin-top: 18px;
  display: flex;
  justify-content: center;
}

/* Butoane */
.pill{
  display:block; text-align:center; padding:12px 16px; border-radius:16px;
  font-weight:800; color:#fff; text-decoration:none;
  box-shadow:0 6px 16px rgba(0,0,0,.12)
}
.pill-blue{ background:#1e88e5 }
.pill-red { background:#e53935 }

/* Conținutul din dreapta */
.posts-title{
  text-align:center; margin:0 0 14px; color:#114411; letter-spacing:2px;
  border-top:3px dashed #1b5e20; padding-top:12px;
}
.search-bar{ margin-bottom:20px }
#searchInput{ width:100%; padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc }

/* Card postare */
.post-item{
  background:#fff; border-left:5px solid #28a745; margin-bottom:20px; padding:15px; border-radius:8px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}
.post-head{ margin-bottom:8px }
.post-title{ margin:0 0 6px }
.meta{ display:block; color:#666; font-size:13px }
.post-body{ margin-top:8px }
.gallery-img{ max-width:100%; border-radius:6px; margin:10px 0 }
.post-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }

/* Butoane card */
.btn{ display:inline-block; padding:10px 14px; border-radius:10px; background:#2f8f4f; color:#fff; text-decoration:none; font-weight:800 }
.btn:hover{ opacity:.92 }
.btn.ghost{ background:transparent; color:#2f8f4f; border:2px solid #2f8f4f }
.btn-download::after{ content:" ⤓"; font-weight:900; }

/* Responsive */
@media (max-width: 980px){
  .blog-wrap{ grid-template-columns:1fr }
  .blog-dna{ position:static; min-height:unset; display:flex; flex-direction:column; align-items:center }
  .dna-slim{ width:140px }
  .blog-dna-nav{
    position: static;
    transform: none;
    width: 100%;
    max-width: 440px;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px;
    margin-top: 10px;
  }
  .blog-dna-nav-secondary{ justify-content:center }
}
</style>

<script>
const FILTER_MAP = {
  '#all': 'all',
  '#insta': 'insta',
  '#articles': 'articles',
  '#galerie': 'gallery',   // hash în română -> valoare din DB
  '#lectii': 'lectii'
};

function filterContent(section) {
  const allPosts = document.querySelectorAll('.post-item');
  allPosts.forEach(post => {
    const postSection = post.getAttribute('data-section');
    post.style.display = (section === 'all' || postSection === section) ? 'block' : 'none';
  });
}

function highlightActive(section){
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  // găsește hash-ul corespunzător secțiunii curente
  const matchHash = Object.keys(FILTER_MAP).find(h => FILTER_MAP[h] === section);
  if(matchHash){
    document.querySelectorAll(`.blog-dna-nav a[href$="${matchHash}"], .blog-dna-nav-secondary a[href$="${matchHash}"]`)
      .forEach(a=>a.classList.add('active'));
  }
}

function applyFromHash(){
  const h = (location.hash || '').toLowerCase();
  const section = FILTER_MAP[h] || 'all';
  filterContent(section);
  highlightActive(section);
}

// Interceptează click-urile pe butoanele cu hash, setează hash-ul și aplică filtrul
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.blog-dna-nav a, .blog-dna-nav-secondary a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const href = a.getAttribute('href') || '';
      const i = href.indexOf('#');
      if (i !== -1){
        e.preventDefault();
        location.hash = href.substring(i);
        applyFromHash();
      }
    });
  });

  applyFromHash(); // aplică filtrul la încărcarea paginii
});

// Dacă utilizatorul schimbă hash-ul manual
window.addEventListener('hashchange', applyFromHash);

// Căutarea după titlu rămâne neschimbată
function searchPosts() {
  const input = (document.getElementById("searchInput").value || "").toLowerCase();
  const posts = document.querySelectorAll(".post-item");
  posts.forEach(post => {
    const title = (post.getAttribute("data-title") || "").toLowerCase();
    post.style.display = title.includes(input) ? "block" : "none";
  });
}
</script>

{% endblock %}
